<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Olivier Guyon" />
  <title>PIAACMC design</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="/home/olivier/.css/pandoc.css" type="text/css" />
</head>
<body>
<div id="header">
<h1 class="title">PIAACMC design</h1>
<h2 class="author">Olivier Guyon</h2>
<h3 class="date">2015-present</h3>
</div>
<div id="TOC">
<ul>
<li><a href="#overview"><span class="toc-section-number">1</span> Overview</a><ul>
<li><a href="#scope"><span class="toc-section-number">1.1</span> Scope</a></li>
<li><a href="#usage"><span class="toc-section-number">1.2</span> Usage</a></li>
</ul></li>
<li><a href="#quick-start"><span class="toc-section-number">2</span> Quick start</a><ul>
<li><a href="#aplcmc-example-script"><span class="toc-section-number">2.1</span> APLCMC example script</a></li>
<li><a href="#piaacmc-example-script"><span class="toc-section-number">2.2</span> PIAACMC example script</a></li>
</ul></li>
<li><a href="#c-code-description"><span class="toc-section-number">3</span> C code description</a><ul>
<li><a href="#piaacmc_designcodes"><span class="toc-section-number">3.1</span> PIAACMC_designcodes</a></li>
</ul></li>
<li><a href="#design-steps-for-piaacmc"><span class="toc-section-number">4</span> Design Steps for PIAACMC</a></li>
<li><a href="#initialization-rules-function-piaasimul_initpiaacmc"><span class="toc-section-number">5</span> Initialization rules (function PIAAsimul_initpiaacmc() )</a><ul>
<li><a href="#mode-000-create-an-idealized-centrally-obscured-apodized-piaacmc-monochromatic-design"><span class="toc-section-number">5.1</span> MODE 000: Create an idealized centrally obscured apodized PIAACMC monochromatic design</a><ul>
<li><a href="#code-breakdown"><span class="toc-section-number">5.1.1</span> Code breakdown</a></li>
<li><a href="#output-files"><span class="toc-section-number">5.1.2</span> Output Files</a></li>
</ul></li>
<li><a href="#step-002-specify-input-pupil-geometry"><span class="toc-section-number">5.2</span> STEP 002: Specify input pupil geometry</a></li>
<li><a href="#step-003-mode-0-compute-on-axis-psf-for-new-pupil-geometry"><span class="toc-section-number">5.3</span> STEP 003 (mode = 0): compute on-axis PSF for new pupil geometry</a></li>
<li><a href="#step-004-mode-5-compute-lyot-stops-shapes-and-locations-1st-pass"><span class="toc-section-number">5.4</span> STEP 004 (mode = 5): Compute Lyot stops shapes and locations, 1st pass</a></li>
<li><a href="#step-005-mode-2-optimize-focal-plane-mask-transmission-1st-pass"><span class="toc-section-number">5.5</span> STEP 005 (mode = 2): Optimize focal plane mask transmission, 1st pass</a></li>
<li><a href="#step-006-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput"><span class="toc-section-number">5.6</span> STEP 006 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</a></li>
<li><a href="#step-007-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-10-cosine-modes-5-fourier-modes"><span class="toc-section-number">5.7</span> STEP 007 (mode = 40): Tune PIAA shapes and focal plane mask transm, 10 cosine modes, 5 Fourier modes</a></li>
<li><a href="#step-008-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes"><span class="toc-section-number">5.8</span> STEP 008 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</a></li>
<li><a href="#step-009-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput"><span class="toc-section-number">5.9</span> STEP 009 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</a></li>
<li><a href="#step-010-mode-1-tune-lyot-stops-conjugations"><span class="toc-section-number">5.10</span> STEP 010 (mode = 1): Tune Lyot stops conjugations</a></li>
<li><a href="#step-011-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes"><span class="toc-section-number">5.11</span> STEP 011 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</a></li>
<li><a href="#step-012-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-40-cosine-modes-150-fourier-modes"><span class="toc-section-number">5.12</span> STEP 012 (mode = 40): Tune PIAA shapes and focal plane mask transm, 40 cosine modes, 150 Fourier modes</a></li>
<li><a href="#step-013-mode-5-compute-lyot-stops-shapes-and-locations-3nd-pass-70-throughput"><span class="toc-section-number">5.13</span> STEP 013 (mode = 5): Compute Lyot stops shapes and locations, 3nd pass, 70% throughput</a></li>
</ul></li>
<li><a href="#low-level-c-code"><span class="toc-section-number">6</span> Low-level C code</a><ul>
<li><a href="#key-functions"><span class="toc-section-number">6.1</span> Key functions</a></li>
<li><a href="#full-piaacmc-design-in-monochromatic-light"><span class="toc-section-number">6.2</span> Full PIAACMC design in monochromatic light</a></li>
<li><a href="#aplc-design"><span class="toc-section-number">6.3</span> APLC design</a></li>
<li><a href="#focal-plane-mask-optimization"><span class="toc-section-number">6.4</span> Focal plane mask optimization</a><ul>
<li><a href="#overall-flow"><span class="toc-section-number">6.4.1</span> Overall flow</a></li>
<li><a href="#regularization"><span class="toc-section-number">6.4.2</span> Regularization</a></li>
<li><a href="#key-files"><span class="toc-section-number">6.4.3</span> Key files</a></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="overview" class="section level1">
<h1><span class="header-section-number">1</span> Overview</h1>
<div id="scope" class="section level2">
<h2><span class="header-section-number">1.1</span> Scope</h2>
<p>Diffraction-based PIAACMC simulation / optimization</p>
<ul>
<li>Uses Fresnel propagation engine ( OptSystProp.c OptSystProp.h ) between optical elements</li>
<li>Computes linear perturbations around current design for optimization</li>
<li>Automatically computes multiple Lyot stop to follow variable conjugation in different parts of the beam</li>
<li>Polychromatic propagations</li>
<li>Fits aspheric PIAA shapes on basis of radial cosines and 2-D Fourier modes</li>
</ul>
</div>
<div id="usage" class="section level2">
<h2><span class="header-section-number">1.2</span> Usage</h2>
<p>Scripts to run the software are located within the source code directory:</p>
<pre><code>./src/PIAACMCsimul/scripts/</code></pre>
<p>The scripts can be linked to your working directory by executing the following command:</p>
<pre><code>ln -s $PWD/syncscripts /myworkdirectory/syncscripts</code></pre>
<p>Then, execute in your work directory:</p>
<pre><code>./syncscripts</code></pre>
<p>This will install all required scripts in workdirectory and install any packages required.</p>
<p>Code is composed of a several layers (from high to low) :</p>
<table>
<colgroup>
<col width="26%" />
<col width="73%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Script</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>run</strong></td>
<td align="center">Top level script, calls <strong>runopt</strong> script</td>
</tr>
<tr class="even">
<td align="left"><strong>runopt</strong></td>
<td align="center">Optimize a PIAACMC design or run an existing design calls <strong>sim</strong> script</td>
</tr>
<tr class="odd">
<td align="left"><strong>sim</strong></td>
<td align="center">calls <strong>runPIAACMC</strong> script</td>
</tr>
<tr class="even">
<td align="left"><strong>runPIAACMC</strong></td>
<td align="center">lower-level script calling C-written executable</td>
</tr>
</tbody>
</table>
<div class="figure">
<img src="figures/scripts_flow.jpg" alt="scripts" />
<p class="caption">scripts</p>
</div>
<p><a href="PIAACMCsimul_script_run.html">Detailed description of script run</a><br />
<a href="PIAACMCsimul_script_runopt.html">Detailed description of script runopt</a><br />
<a href="PIAACMCsimul_script_sim.html">Detailed description of script sim</a><br />
<a href="PIAACMCsimul_script_runPIAACMC.html">Detailed description of script runPIAACMC</a></p>
</div>
</div>
<div id="quick-start" class="section level1">
<h1><span class="header-section-number">2</span> Quick start</h1>
<p>The quickest way to get started is to run and modify one of the example design scripts provided in the <code>./examples/</code> directory</p>
<div id="aplcmc-example-script" class="section level2">
<h2><span class="header-section-number">2.1</span> APLCMC example script</h2>
</div>
<div id="piaacmc-example-script" class="section level2">
<h2><span class="header-section-number">2.2</span> PIAACMC example script</h2>
</div>
</div>
<div id="c-code-description" class="section level1">
<h1><span class="header-section-number">3</span> C code description</h1>
<div id="piaacmc_designcodes" class="section level2">
<h2><span class="header-section-number">3.1</span> PIAACMC_designcodes</h2>
<p>The main function in the source code is PIAACMCsimul_exec(), which takes two arguments: the configuration index (usually a 3 digit integer) and the mode (integer) which describes the operation to be performed to the PIAACMC design.</p>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Mode</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0 *</td>
<td>Compute on-axis propagation for specified configuration. If configuration does not exist, create idealized monochromatic PIAACMC (intended to create a new index) and compute on-axis propagation</td>
</tr>
<tr class="even">
<td>1 *</td>
<td>Optimize Lyot stop(s) locations (scan)</td>
</tr>
<tr class="odd">
<td>2 *</td>
<td>Optimize focal plane mask transmission for idealized monochromatic PIAACMC (scan)</td>
</tr>
<tr class="even">
<td>3</td>
<td>Run without focal plane mask (for testing and calibration)</td>
</tr>
<tr class="odd">
<td>4</td>
<td>Linear optimization around current design, free parameters = PIAA optics cosines shapes (track progress by looking at val.opt file)</td>
</tr>
<tr class="even">
<td>5 *</td>
<td>Optimize Lyot stops shapes and positions</td>
</tr>
<tr class="odd">
<td>10 *</td>
<td>Setup polychromatic optimization</td>
</tr>
<tr class="even">
<td>11 *</td>
<td>Compute polychromatic response to zones, store result in FPMresp</td>
</tr>
<tr class="odd">
<td>12</td>
<td>Search for best mask solution using FPMresp, random search</td>
</tr>
<tr class="even">
<td>13 *</td>
<td>Optimize PIAA optics shapes and focal plane mask transmission (idealized PIAACMC)</td>
</tr>
<tr class="odd">
<td>40 *</td>
<td>Optimize PIAA optics shapes and focal plane mask transmission (idealized PIAACMC)</td>
</tr>
<tr class="even">
<td>41</td>
<td>Optimize PIAA optics shapes and focal plane mask zones (polychromatic)</td>
</tr>
<tr class="odd">
<td>100 *</td>
<td>Evaluate current design: polychromatic contrast, pointing sensitivity</td>
</tr>
<tr class="even">
<td>101 *</td>
<td>Transmission as a function of angular separation</td>
</tr>
<tr class="odd">
<td>200 *</td>
<td>Make focal plane mask OPD map</td>
</tr>
</tbody>
</table>
<p>The following variables can be set</p>
<table style="width:88%;">
<colgroup>
<col width="34%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PIAACMC_size</td>
<td>Array size (1024, 2048, etc...)</td>
</tr>
<tr class="even">
<td>PIAACMC_pixscale</td>
<td>Pixel scale [m]</td>
</tr>
<tr class="odd">
<td>PIAACMC_dftgrid</td>
<td>Sampling interval in DFTs</td>
</tr>
<tr class="even">
<td>PIAACMC_centobs0</td>
<td>Input central obstruction</td>
</tr>
<tr class="odd">
<td>PIAACMC_centobs1</td>
<td>Output central obstruction</td>
</tr>
<tr class="even">
<td>PIAACMC_nblambda</td>
<td>Number of wavelength points</td>
</tr>
<tr class="odd">
<td>PIAACMC_resolved</td>
<td>1 if resolved source (3 points at r = 0.01 l/D, 120 deg apart)</td>
</tr>
<tr class="even">
<td>PIAACMC_fpmtype</td>
<td>1 if physical mask, 0 if idealized mask</td>
</tr>
<tr class="odd">
<td>PIAACMC_FPMsectors</td>
<td>Number of sectors in focal plane mask</td>
</tr>
<tr class="even">
<td>PIAACMC_NBrings</td>
<td>Number of rings in focal plane mask</td>
</tr>
<tr class="odd">
<td>PIAACMC_fpmradld</td>
<td>Focal plane mask outer radius</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="design-steps-for-piaacmc" class="section level1">
<h1><span class="header-section-number">4</span> Design Steps for PIAACMC</h1>
<p>Directories &quot;./piaacmcconf<nnn>/&quot; hold the default/current configuration settings and files for the PIAACMC. The directory will be automatically created if it does not exist. By copying from/to this directory, you can save/load PIAACMC designs.</p>
<p>By default, if no configuration file exists, a monochromatic PIAACMC for a centrally obscured pupil will be created. This is meant as a starting point for the PIAACMC, which will then be optimized further</p>
<p>The main command to run the PIAACMC simulation is <executable> piaacmcsimrun <nnn> <mode> exit </p>
<p>where <nnn> [long] is the configuration index and <mode> [long] defines the operation to be performed.See function PIAACMCsimul_run(long confindex, long mode) for list of modes</p>
<p>The PIAACMC design process is as follows: -# design an idealized monochromatic PIAACMC for a centrally obscured aperture (steps 1-4) -# modify the design for the pupil aperture (steps 5-)</p>
</div>
<div id="initialization-rules-function-piaasimul_initpiaacmc" class="section level1">
<h1><span class="header-section-number">5</span> Initialization rules (function PIAAsimul_initpiaacmc() )</h1>
<p>-# if configuration directory exists, use it and load configuration file ( function PIAAsimul_loadpiaacmcconf ), otherwise, create it -# load/create Cmodes -# load/create Fmodes -# load mode coefficients for piaa shapes if they exist. If not: -# create radial apodization for centrally obscured idealized monochromatic PIAACMC -# fit / extrapolate radial apodization profile with cosines -# using above fit, create 2D radial sag for both PIAA optics ( -&gt; PIAA_Mshapes.txt) -# make 2D sag maps for both optics ( -&gt; piaa0z.fits, piaa1z.fits) -# fit 2D sag maps with Cmodes and Fmodes coefficients ( -&gt; piaa0Cmodes, piaa0Fmodes, piaa1Cmodes, piaa1Fmodes ) -# load/create focal plane mask zone map. This is the map that defines the geometry (which ring is where) -# load/create focal plane mask thickness array -# load/create focal plane mask transmission array -# load/create Lyot stops</p>
<div id="mode-000-create-an-idealized-centrally-obscured-apodized-piaacmc-monochromatic-design" class="section level2">
<h2><span class="header-section-number">5.1</span> MODE 000: Create an idealized centrally obscured apodized PIAACMC monochromatic design</h2>
<p>This is meant as a starting point for the PIAACMC, which will then be optimized furtherOptional parameters are: - PIAACMC_size : array size (default = 1024) - PIAACMC_pixscale : pixel scale (m/pix) - PIAACMC_nblambda : number of wavelengths (1 for monochromatic) - PIAACMC_dftgrid : DFT grid sampling gap [pix] in pupil plane - PIAACMC_centobs0 : central obstruction in input pupil (default = 0.3) - PIAACMC_centobs1 : central obstruction after remapping (default = 0.2) - PIAACMC_fpmradld : focal plane mask radius for monochromatic idealized design, in l/D system unit (default = 0.9)</p>
<p><executable> PIAACMC_size=1024 PIAACMC_pixscale=0.00011 PIAACMC_nblambda=1 PIAACMC_dftgrid=2 PIAACMC_centobs0=0.3 PIAACMC_centobs1=0.15 PIAACMC_fpmradld=1.0 PIAACMC_dftgrid=2 piaacmcsimrun 0 0 exit </p>
<p>This will create the prolate function for a centrally obscured pupil, the idealized focal plane mask, and run the diffraction propagation.This step takes a few minutes - most of the time is spent on iterations to compute the 2D apodization prolate function.</p>
<p>Run this twice: once to set up the configuration, and once to run the on-axis PSF.</p>
<p>After this step, the contrast will likely be around 1e-7. The next step to improve this nominal design is to find the optimal locations for the Lyot stops.</p>
<p>Example result (for 1 l/D mask, 2048 array size): Peak constrast (rough estimate)= 2.02762e-06 Total light in scoring field = 9.49968e-06 -&gt; Average contrast = 6.88685e-08 </p>
<div id="code-breakdown" class="section level3">
<h3><span class="header-section-number">5.1.1</span> Code breakdown</h3>
<ul>
<li>PIAACMCsimul_exec() :
<ul>
<li>PIAAsimul_initpiaacmcconf(): Load/Creates/initializes piaacmcconf structure and directory
<ul>
<li>perform default initialization</li>
<li>PIAAsimul_loadpiaacmcconf(): Loading PIAACMC configuration from &quot;piaacmcconfxxx/piaacmcparams.conf&quot; if it exists</li>
<li>Creating/loading Cmodes and Fmodes</li>
<li>IMPORT / CREATE PIAA SHAPES
<ul>
<li>create 2D prolate iteratively</li>
<li>PIAACMCsimul_load2DRadialApodization():fit PIAA shapes with Cosine modes</li>
<li>PIAACMCsimul_init_geomPIAA_rad(): compute radial PIAA sag from cosine apodization fit</li>
<li>PIAACMCsimul_mkPIAAMshapes_from_RadSag(): Make 2D sag shapes from radial PIAA sag</li>
</ul></li>
<li>MAKE FOCAL PLANE MASK</li>
<li>MAKE LYOT STOPS</li>
<li>PIAAsimul_savepiaacmcconf(): save configuration</li>
</ul></li>
<li>PIAACMCsimul_makePIAAshapes(): construct PIAA shapes from fitting coefficients
<ul>
<li>construct 2D PIAA mirror shapes from piaa0Cmodescoeff, piaa0Fmodescoeff, piaa1Cmodescoeff, piaa1Fmodescoeff</li>
</ul></li>
<li>PIAACMCsimul_computePSF(): Compute PSF</li>
</ul></li>
</ul>
</div>
<div id="output-files" class="section level3">
<h3><span class="header-section-number">5.1.2</span> Output Files</h3>
<p>APLCmaskCtransm.txt ?? fpm_ampl.fits fpm_pha.fits FPmask.tmp.fits</p>
<div id="configuration" class="section level4">
<h4><span class="header-section-number">5.1.2.1</span> Configuration :</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/piaacmcparams.conf</td>
<td>Configuration parameters</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/conjugations.txt</td>
<td>Conjugations</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/lambdalist.txt</td>
<td>list of wavelength values</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/pupa0_[size].fits</td>
<td>input pupil (created by default if does not exist)</td>
</tr>
</tbody>
</table>
</div>
<div id="wavefront-modes" class="section level4">
<h4><span class="header-section-number">5.1.2.2</span> Wavefront Modes :</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cmodes.fits</td>
<td>circular radial cosine modes (40 modes, hard coded)</td>
</tr>
<tr class="even">
<td>Fmodes.fits</td>
<td>Fourier modes (625 modes = 10 CPA, hard coded)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/ModesExpr_CPA.txt</td>
<td>modes definition</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/APOmodesCos.fits</td>
<td>Cosine modes for fitting 2D apodization profile</td>
</tr>
</tbody>
</table>
</div>
<div id="piaa-mirrors-apodization-fits" class="section level4">
<h4><span class="header-section-number">5.1.2.3</span> PIAA mirrors, apodization, fits:</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/APLCapo.1.400.0.300.info</td>
<td>file written by prolate generation function coronagraph_make_2Dprolate in coronagraphs.c</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/apo2Drad.fits</td>
<td>idealized PIAACMC 2D apodization</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaam0z.fits</td>
<td>PIAA M0 shape (2D sag)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaam1z.fits</td>
<td>PIAA M1 shape (2D sag)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/PIAA_Mshapes.txt</td>
<td>PIAA shapes (radial txt file, cols: r0, z0, r1, z1)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Fz.fits</td>
<td>PIAA M0 shape, Fourier components (2D file)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Fz.fits</td>
<td>PIAA M1 shape, Fourier components (2D file)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Cmodes.fits</td>
<td>idealized PIAACMC mirror 0 cosine modes (copied from ./piaaref/)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa0Fmodes.fits</td>
<td>idealized PIAACMC mirror 0 Fourier modes (copied from ./piaaref/)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa1Cmodes.fits</td>
<td>idealized PIAACMC mirror 1 cosine modes (copied from ./piaaref/)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Fmodes.fits</td>
<td>idealized PIAACMC mirror 1 Fourier modes (copied from ./piaaref/)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Cres.fits</td>
<td>idealized PIAA M0 cosine fit residual</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Cres.fits</td>
<td>idealized PIAA M1 cosine fit residual</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Cz.fits</td>
<td>idealized PIAA M0 cosine fit sag</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Cz.fits</td>
<td>idealized PIAA M1 cosine fit sag</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Fz.fits</td>
<td>idealized PIAA M0 Fourier fit sag</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Fz.fits</td>
<td>idealized PIAA M1 Fourier fit sag</td>
</tr>
</tbody>
</table>
</div>
<div id="idealized-piaacmc-reference-point" class="section level4">
<h4><span class="header-section-number">5.1.2.4</span> Idealized PIAACMC reference point:</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/piaaref/APLCmaskCtransm.txt</td>
<td>idealized PIAACMC focal plane mask transmission</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaaref/apo2Drad.fits</td>
<td>idealized PIAACMC output apodization</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaaref/piaa0Cmodes.fits</td>
<td>idealized PIAACMC mirror 0 cosine modes</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaaref/piaa0Fmodes.fits</td>
<td>idealized PIAACMC mirror 0 Fourier modes</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaaref/piaa1Cmodes.fits</td>
<td>idealized PIAACMC mirror 1 cosine modes</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaaref/piaa1Fmodes.fits</td>
<td>idealized PIAACMC mirror 1 Fourier modes</td>
</tr>
</tbody>
</table>
</div>
<div id="focal-plane-mask" class="section level4">
<h4><span class="header-section-number">5.1.2.5</span> Focal plane mask:</h4>
<p>Focal plane mask design defined by : - [s] Sectors flag (0: no sectors, 1: sectors), variable PIAACMC_FPMsectors - [r] Resolved target flag (0: point source, 1: resolved source) - [mr] Mask radius in units of 0.1 l/D - [rrr] number of rings, variable piaacmc[0].NBrings - [zzz] number of zones</p>
<table>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fpmzmap[s]<em>[rrr]</em>[zzz].fits</td>
<td>Zones map</td>
</tr>
<tr class="even">
<td>fpm_zonea[r][s]<em>[mr]</em>[rrr]_[zzz].fits</td>
<td>amplitude for each zone</td>
</tr>
<tr class="odd">
<td>fpm_zonea[r][s]<em>[mr]</em>[rrr]_[zzz].fits</td>
<td>thickness for each zone</td>
</tr>
</tbody>
</table>
<p>IDEALIZED OR PHYSICAL MASK</p>
<p>Idealized mask is a single zone mask with thickness adjusted for lambda/2 phase shift and a (non-physical) partial transmission. Physical mask consist of 1 or more zones with full transmission. Each zone can have a different thickness.</p>
<p>By default, a non-physical mask is first created with transmission piaacmc[0].fpmaskamptransm read from piaacmcparams.conf. Computations indices using a physical mask: - set transmission to 1.0: piaacmc[0].fpmaskamptransm = 1.0. - set focal plane mask radius to larger value: piaacmc[0].fpmRad = 0.5<em>(LAMBDASTART+LAMBDAEND)</em>piaacmc[0].Fratio * PIAACMC_MASKRADLD</p>
</div>
<div id="lyot-stops" class="section level4">
<h4><span class="header-section-number">5.1.2.6</span> Lyot stops:</h4>
<table>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/LyotStop0.fits</td>
<td>Lyot Stop 0</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/LyotStop1.fits</td>
<td>Lyot Stop 1</td>
</tr>
</tbody>
</table>
</div>
<div id="amplitude-phase-at-planes" class="section level4">
<h4><span class="header-section-number">5.1.2.7</span> Amplitude &amp; Phase at planes:</h4>
<p>Files are /piaaconfxxx/WFamp_nnn.fits and WFpha_nnn.fits, where nnn is the plane index.Complex amplitude is shown AFTER the element has been applied, in the plane of the element.</p>
<table>
<thead>
<tr class="header">
<th>Plane index</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>000</td>
<td>Input pupil</td>
</tr>
<tr class="even">
<td>001</td>
<td>Fold mirror used to induce pointing offsets</td>
</tr>
<tr class="odd">
<td>002</td>
<td>PIAA M0</td>
</tr>
<tr class="even">
<td>003</td>
<td>PIAA M1</td>
</tr>
<tr class="odd">
<td>004</td>
<td>PIAAM1 edge opaque mask</td>
</tr>
<tr class="even">
<td>005</td>
<td>post-focal plane mask pupil</td>
</tr>
<tr class="odd">
<td>006</td>
<td>Lyot Stop 0</td>
</tr>
<tr class="even">
<td>007</td>
<td>Lyot Stop 1</td>
</tr>
<tr class="odd">
<td>008</td>
<td>invPIAA1</td>
</tr>
<tr class="even">
<td>009</td>
<td>invPIAA0</td>
</tr>
<tr class="odd">
<td>010</td>
<td>back end mask</td>
</tr>
</tbody>
</table>
</div>
<div id="performance-evaluation" class="section level4">
<h4><span class="header-section-number">5.1.2.8</span> Performance Evaluation:</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Plane index</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/scoringmask0.fits</td>
<td>Evaluation points in focal plane, hardcoded in PIAACMCsimul_computePSF()</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/CnormFactor.txt</td>
<td>PSF normalization factor used to compute contrast</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/flux.txt</td>
<td>total intensity at each plane</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="step-002-specify-input-pupil-geometry" class="section level2">
<h2><span class="header-section-number">5.2</span> STEP 002: Specify input pupil geometry</h2>
<p>The pupil geometry is copied to file ./piaacmcconf[nnn]/pupa0_[size].fits</p>
</div>
<div id="step-003-mode-0-compute-on-axis-psf-for-new-pupil-geometry" class="section level2">
<h2><span class="header-section-number">5.3</span> STEP 003 (mode = 0): compute on-axis PSF for new pupil geometry</h2>
</div>
<div id="step-004-mode-5-compute-lyot-stops-shapes-and-locations-1st-pass" class="section level2">
<h2><span class="header-section-number">5.4</span> STEP 004 (mode = 5): Compute Lyot stops shapes and locations, 1st pass</h2>
<p>For circular centrally obscured pupils, the default Lyot stops configuration consists of two stops: one that masks the outer part of the beam, and one that masks the central obstruction.</p>
<p>Fine optimization of the stops locations is done with a separate command. The optional lsoptrange value is the range (unit: m) for the mask position search (default = 2 m).</p>
<p>Example result (for 1 l/D mask, 2048 array size): Peak constrast (rough estimate)= 1.78874e-06 Total light in scoring field = 7.75534e-06 -&gt; Average contrast = 5.62228e-08 </p>
</div>
<div id="step-005-mode-2-optimize-focal-plane-mask-transmission-1st-pass" class="section level2">
<h2><span class="header-section-number">5.5</span> STEP 005 (mode = 2): Optimize focal plane mask transmission, 1st pass</h2>
</div>
<div id="step-006-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput" class="section level2">
<h2><span class="header-section-number">5.6</span> STEP 006 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</h2>
</div>
<div id="step-007-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-10-cosine-modes-5-fourier-modes" class="section level2">
<h2><span class="header-section-number">5.7</span> STEP 007 (mode = 40): Tune PIAA shapes and focal plane mask transm, 10 cosine modes, 5 Fourier modes</h2>
<p>This takes approximately 20mn for size = 1024.Progress can be tracked by watching file : tail -f linoptval.txt </p>
</div>
<div id="step-008-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes" class="section level2">
<h2><span class="header-section-number">5.8</span> STEP 008 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</h2>
</div>
<div id="step-009-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput" class="section level2">
<h2><span class="header-section-number">5.9</span> STEP 009 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</h2>
</div>
<div id="step-010-mode-1-tune-lyot-stops-conjugations" class="section level2">
<h2><span class="header-section-number">5.10</span> STEP 010 (mode = 1): Tune Lyot stops conjugations</h2>
</div>
<div id="step-011-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes" class="section level2">
<h2><span class="header-section-number">5.11</span> STEP 011 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</h2>
</div>
<div id="step-012-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-40-cosine-modes-150-fourier-modes" class="section level2">
<h2><span class="header-section-number">5.12</span> STEP 012 (mode = 40): Tune PIAA shapes and focal plane mask transm, 40 cosine modes, 150 Fourier modes</h2>
<p>The total number of free parameters is 380 = (40+150)*2, so this routine takes a long time to complete (hours).</p>
</div>
<div id="step-013-mode-5-compute-lyot-stops-shapes-and-locations-3nd-pass-70-throughput" class="section level2">
<h2><span class="header-section-number">5.13</span> STEP 013 (mode = 5): Compute Lyot stops shapes and locations, 3nd pass, 70% throughput</h2>
</div>
</div>
<div id="low-level-c-code" class="section level1">
<h1><span class="header-section-number">6</span> Low-level C code</h1>
<div id="key-functions" class="section level2">
<h2><span class="header-section-number">6.1</span> Key functions</h2>
<p>Every time a PSF is computed, the following 3 functions are created in that order:</p>
<ul>
<li><code>PIAAsimul_initpiaacmcconf</code>
<ul>
<li>initialize piaacmc</li>
<li>create modes for aspheric optical surfaces description</li>
<li>CREATE DMs (Cmodes and Fmodes)</li>
<li>IMPORT / CREATE PIAA SHAPES</li>
<li>if does not exist: Creating 2D apodization for idealized circular monochromatic PIAACMC</li>
<li>compute radial PIAA sag, make 2D sag maps</li>
<li>MAKE FOCAL PLANE MASK</li>
<li>MAKE LYOT STOPS (LOADING/CREATING LYOT MASK)</li>
</ul></li>
<li><p><code>PIAACMCsimul_init(piaacmc, 0, xld, yld)</code> : initializes optical system to piaacmc design</p></li>
<li><p><code>PIAACMCsimul_makePIAAshapes(piaacmc, 0)</code> : create 2D PIAA shapes (<code>piaam0z</code> and <code>piaam1z</code>) from coefficient values and modes</p></li>
<li><p><code>OptSystProp_run(optsyst, 0, startelem, optsyst[0].NBelem, piaacmcconfdir, 0)</code> : perform optical propagation</p></li>
</ul>
<p>Note that the last 3 functions are wrapped togeter in the computePSF function, which allows multi-point (extended sources) :</p>
<ul>
<li><code>PIAACMCsimul_computePSF(float xld, float yld, long startelem, long endelem, int savepsf, int sourcesize, int extmode, int outsave)</code> : compute PSF
<ul>
<li><code>PIAACMCsimul_init(piaacmc, 0, xld+rad1, yld)</code></li>
<li><code>PIAACMCsimul_makePIAAshapes(piaacmc, 0)</code></li>
<li><code>OptSystProp_run(optsyst, 0, startelem, optsyst[0].NBelem, piaacmcconfdir, 0)</code></li>
</ul></li>
</ul>
</div>
<div id="full-piaacmc-design-in-monochromatic-light" class="section level2">
<h2><span class="header-section-number">6.2</span> Full PIAACMC design in monochromatic light</h2>
<p>The first step of the optimization process is to compute the PIAACMC optics and focal plane mask in the idealized case: monochromatic light, point source, and ideal focal plane mask (circular, phase-shifting and partially transmissive). Steps are shown in the figure below and correspond to steps in the <code>runPIAACMC</code> state machine.</p>
<div class="figure">
<img src="figures/runPIAACMCsteps.jpg" alt="PIAACMC design steps" />
<p class="caption">PIAACMC design steps</p>
</div>
</div>
<div id="aplc-design" class="section level2">
<h2><span class="header-section-number">6.3</span> APLC design</h2>
<p>The scripts produce an APLC design by setting <code>PIAAmode = 0</code>. In that case, only <code>step000</code> in the figure above is executed.</p>
</div>
<div id="focal-plane-mask-optimization" class="section level2">
<h2><span class="header-section-number">6.4</span> Focal plane mask optimization</h2>
<div id="overall-flow" class="section level3">
<h3><span class="header-section-number">6.4.1</span> Overall flow</h3>
<p>FPM optimization is done as <code>mode = 13</code> in the main routine. It is called from the <code>runPIAACMC</code> script.<br />
The <code>PIAACMCsimul_run(char *confindex, long mode)</code> function loop-calls the <code>PIAACMCsimul_exec(char *confindex, long mode)</code> function with mode 13 until search time is reached.</p>
<p>Each search proceeds as follows :</p>
<ul>
<li>a starting point is picked. A random integer <code>zeroST</code> encodes the starting poing:
<ul>
<li>0:</li>
<li>1: start at zero</li>
<li>2: start at best solution</li>
</ul></li>
<li>run <code>PIAACMCsimul_exec</code> in mode 13
<ul>
<li>randomly move next to starting point</li>
<li>compute value and store it to valref variable</li>
<li>enter gradient search loop
<ul>
<li>compute local derivatives</li>
<li>compute SVD of Jacobian matrix to identify vectors of steepest descent</li>
<li>for each alphareg = 0, 0.25, 0.5, 0.75, 1.0:
<ul>
<li>do a linescan descent along the vector identified by SVD, with the alphareg regularization coefficient</li>
<li>the best value is stored as <code>bestval</code> and the corresponding parameters into <code>data.image[IDoptvec].array.F[i]</code></li>
<li>store best values in <code>PIAACMCSIMUL_VAL</code>, and reference value in <code>PIAACMCSIMUL_VALREF</code></li>
</ul></li>
</ul></li>
</ul></li>
<li><code>computePSF_FAST_FPMresp = 1</code> : uses pre-computed complex amplitude zones response to evaluate FPM solutions</li>
<li><code>PIAACMC_FPM_FASTDERIVATIVES = 1</code></li>
</ul>
<p>To stop the optimization and have the current best solution adopted, enter a small value in the <code>searchtime.txt</code> file, so that the optimization process completes.</p>
</div>
<div id="regularization" class="section level3">
<h3><span class="header-section-number">6.4.2</span> Regularization</h3>
<p>There are two regularization:</p>
<ul>
<li>Focal plane mask zone sags can be included in the linear optimization as extra components to the optimization vector</li>
<li>PIAA shapes coefficients are simply added to the evaluation metric</li>
</ul>
</div>
<div id="key-files" class="section level3">
<h3><span class="header-section-number">6.4.3</span> Key files</h3>
<ul>
<li><code>fpm_zonez_.....best.fits</code> is the optimal solution</li>
<li><code>mode13_....bestval.txt</code> is the corresponding value</li>
</ul>
<p>To restart the optimization from scratch, remove these two files.</p>
<p>Average contrast = 5.964e-05 0.001 -&gt; Average contrast = 8.57575e-07, 1.9e-7 0.01 -&gt; Average contrast = 7.99085e-07, 2.0e-7 7.8294e-07</p>
</div>
</div>
</div>
</body>
</html>
