<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Olivier Guyon" />
  <title>PIAACMC design</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="/home/olivier/.css/pandoc.css" type="text/css" />
</head>
<body>
<div id="header">
<h1 class="title">PIAACMC design</h1>
<h2 class="author">Olivier Guyon</h2>
<h3 class="date">2015-present</h3>
</div>
<div id="TOC">
<ul>
<li><a href="#overview"><span class="toc-section-number">1</span> Overview</a><ul>
<li><a href="#scope"><span class="toc-section-number">1.1</span> Scope</a></li>
<li><a href="#usage"><span class="toc-section-number">1.2</span> Usage</a></li>
</ul></li>
<li><a href="#quick-start"><span class="toc-section-number">2</span> Quick start</a></li>
<li><a href="#design-steps"><span class="toc-section-number">3</span> Design steps</a><ul>
<li><a href="#overview-1"><span class="toc-section-number">3.1</span> Overview</a></li>
<li><a href="#step-000-mode0-create-an-idealized-centrally-obscured-apodized-piaacmc-monochromatic-design"><span class="toc-section-number">3.2</span> STEP 000 (MODE=0): Create an idealized centrally obscured apodized PIAACMC monochromatic design</a></li>
<li><a href="#step-001-propagate-solution-and-compute-psf"><span class="toc-section-number">3.3</span> STEP 001: Propagate solution and compute PSF</a></li>
<li><a href="#step-002-specify-input-pupil-geometry"><span class="toc-section-number">3.4</span> STEP 002: Specify input pupil geometry</a></li>
<li><a href="#step-003-mode-0-compute-on-axis-psf-for-new-pupil-geometry"><span class="toc-section-number">3.5</span> STEP 003 (mode = 0): compute on-axis PSF for new pupil geometry</a></li>
<li><a href="#step-004-mode-5-compute-lyot-stops-shapes-and-locations-1st-pass"><span class="toc-section-number">3.6</span> STEP 004 (mode = 5): Compute Lyot stops shapes and locations, 1st pass</a></li>
<li><a href="#step-005-mode-2-optimize-focal-plane-mask-transmission-1st-pass"><span class="toc-section-number">3.7</span> STEP 005 (mode = 2): Optimize focal plane mask transmission, 1st pass</a></li>
<li><a href="#step-006-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput"><span class="toc-section-number">3.8</span> STEP 006 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</a></li>
<li><a href="#step-007-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-10-cosine-modes-5-fourier-modes"><span class="toc-section-number">3.9</span> STEP 007 (mode = 40): Tune PIAA shapes and focal plane mask transm, 10 cosine modes, 5 Fourier modes</a></li>
<li><a href="#step-008-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes"><span class="toc-section-number">3.10</span> STEP 008 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</a></li>
<li><a href="#step-009-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput"><span class="toc-section-number">3.11</span> STEP 009 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</a></li>
<li><a href="#step-010-mode-1-tune-lyot-stops-conjugations"><span class="toc-section-number">3.12</span> STEP 010 (mode = 1): Tune Lyot stops conjugations</a></li>
<li><a href="#step-011-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes"><span class="toc-section-number">3.13</span> STEP 011 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</a></li>
<li><a href="#step-012-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-40-cosine-modes-150-fourier-modes"><span class="toc-section-number">3.14</span> STEP 012 (mode = 40): Tune PIAA shapes and focal plane mask transm, 40 cosine modes, 150 Fourier modes</a></li>
<li><a href="#step-013-mode-5-compute-lyot-stops-shapes-and-locations-3nd-pass-70-throughput"><span class="toc-section-number">3.15</span> STEP 013 (mode = 5): Compute Lyot stops shapes and locations, 3nd pass, 70% throughput</a></li>
</ul></li>
<li><a href="#c-code-description"><span class="toc-section-number">4</span> C code description</a><ul>
<li><a href="#piaacmc_designcodes"><span class="toc-section-number">4.1</span> PIAACMC_designcodes</a></li>
</ul></li>
<li><a href="#initialization-rules-function-piaasimul_initpiaacmc"><span class="toc-section-number">5</span> Initialization rules (function PIAAsimul_initpiaacmc() )</a><ul>
<li><a href="#code-breakdown"><span class="toc-section-number">5.0.1</span> Code breakdown</a></li>
<li><a href="#output-files"><span class="toc-section-number">5.0.2</span> Output Files</a></li>
</ul></li>
<li><a href="#low-level-c-code"><span class="toc-section-number">6</span> Low-level C code</a><ul>
<li><a href="#key-functions"><span class="toc-section-number">6.1</span> Key functions</a></li>
<li><a href="#full-piaacmc-design-in-monochromatic-light"><span class="toc-section-number">6.2</span> Full PIAACMC design in monochromatic light</a></li>
<li><a href="#aplc-design"><span class="toc-section-number">6.3</span> APLC design</a></li>
<li><a href="#focal-plane-mask-optimization"><span class="toc-section-number">6.4</span> Focal plane mask optimization</a><ul>
<li><a href="#overall-flow"><span class="toc-section-number">6.4.1</span> Overall flow</a></li>
<li><a href="#regularization"><span class="toc-section-number">6.4.2</span> Regularization</a></li>
<li><a href="#key-files"><span class="toc-section-number">6.4.3</span> Key files</a></li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="overview" class="section level1">
<h1><span class="header-section-number">1</span> Overview</h1>
<div id="scope" class="section level2">
<h2><span class="header-section-number">1.1</span> Scope</h2>
<p>Diffraction-based PIAACMC simulation / optimization</p>
<ul>
<li>Uses Fresnel propagation engine ( OptSystProp.c OptSystProp.h ) between optical elements</li>
<li>Computes linear perturbations around current design for optimization</li>
<li>Automatically computes multiple Lyot stop to follow variable conjugation in different parts of the beam</li>
<li>Polychromatic propagations</li>
<li>Fits aspheric PIAA shapes on basis of radial cosines and 2-D Fourier modes</li>
</ul>
</div>
<div id="usage" class="section level2">
<h2><span class="header-section-number">1.2</span> Usage</h2>
<p>Scripts to run the software are located within the source code directory:</p>
<pre><code>./src/PIAACMCsimul/scripts/</code></pre>
<p>The scripts can be linked to your working directory by executing the following command:</p>
<pre><code>ln -s $PWD/syncscripts /myworkdirectory/syncscripts</code></pre>
<p>Then, execute in your work directory:</p>
<pre><code>./syncscripts</code></pre>
<p>This will install all required scripts in workdirectory and install any packages required.</p>
<p>Code is composed of a several layers (from high to low) :</p>
<table>
<colgroup>
<col width="26%" />
<col width="73%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Script</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>run</strong></td>
<td align="center">Top level script, calls <strong>runopt</strong> script</td>
</tr>
<tr class="even">
<td align="left"><strong>runopt</strong></td>
<td align="center">Optimize a PIAACMC design or run an existing design calls <strong>sim</strong> script</td>
</tr>
<tr class="odd">
<td align="left"><strong>sim</strong></td>
<td align="center">calls <strong>runPIAACMC</strong> script</td>
</tr>
<tr class="even">
<td align="left"><strong>runPIAACMC</strong></td>
<td align="center">lower-level script calling C-written executable</td>
</tr>
</tbody>
</table>
<div class="figure">
<img src="figures/scripts_flow.jpg" alt="scripts" />
<p class="caption">scripts</p>
</div>
<p><a href="PIAACMCsimul_script_run.html">Detailed description of script run</a><br />
<a href="PIAACMCsimul_script_runopt.html">Detailed description of script runopt</a><br />
<a href="PIAACMCsimul_script_sim.html">Detailed description of script sim</a><br />
<a href="PIAACMCsimul_script_runPIAACMC.html">Detailed description of script runPIAACMC</a></p>
</div>
</div>
<div id="quick-start" class="section level1">
<h1><span class="header-section-number">2</span> Quick start</h1>
<p>The quickest way to get started is to run and modify one of the example design scripts provided in the <code>./examples/</code> directory. The bash scripts should be self-explanatory. For further details about the design steps, read the design steps section.</p>
<table>
<colgroup>
<col width="37%" />
<col width="62%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Script</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>exampleAPLCMC</strong></td>
<td align="left">Example APLCMC design (does not include PIAA optics)</td>
</tr>
<tr class="even">
<td align="left"><strong>examplePIAACMC</strong></td>
<td align="left">Example PIAACMC design for a segmented aperture (2028x2048 arrays)</td>
</tr>
<tr class="odd">
<td align="left"><strong>examplePIAACMC_WFIRST1024</strong></td>
<td align="left">Example PIAACMC design for the centrally obscured WFIRST pupil (1024x1024 arrays)</td>
</tr>
</tbody>
</table>
</div>
<div id="design-steps" class="section level1">
<h1><span class="header-section-number">3</span> Design steps</h1>
<div id="overview-1" class="section level2">
<h2><span class="header-section-number">3.1</span> Overview</h2>
<p>The design proceeds in discrete steps. The example scripts show the individual steps, and each step is executed with a separate command line.</p>
<p>Steps from 0 to 99 are executed sequentially to design a monochromatic PIAACMC. For these steps, the user may run multiple steps with a single command. For example, running step 18 will execute all steps from 0 to 17 included. If a step has already been completed, it will not be re-run.</p>
<p>The monochromatic PIAACMC design process is as follows:</p>
<ul>
<li><p>design an idealized monochromatic PIAACMC for a centrally obscured aperture (steps 1-4)</p></li>
<li><p>modify the design for the pupil aperture (steps 5-)</p></li>
</ul>
</div>
<div id="step-000-mode0-create-an-idealized-centrally-obscured-apodized-piaacmc-monochromatic-design" class="section level2">
<h2><span class="header-section-number">3.2</span> STEP 000 (MODE=0): Create an idealized centrally obscured apodized PIAACMC monochromatic design</h2>
<p>This is meant as a starting point for the PIAACMC, which will then be optimized further. This step takes a few minutes, and upon normal completion, display:</p>
<pre><code>./runPIAACMC REACHED STATE EXIT POINT (1)</code></pre>
<p>The prolate function for a centrally obscured pupili is created, along with the idealized focal plane mask. The diffraction propagation code then computes complex amplitude in each plane.</p>
<p>This step takes a few minutes - most of the time is spent on iterations to compute the 2D apodization prolate function, executing discrete Fourier transforms (DFTs).</p>
<p>After this step, the contrast will likely be around 1e-7 to 1e-8. The next step to improve this nominal design is to find the optimal locations for the Lyot stops.</p>
<table>
<colgroup>
<col width="33%" />
<col width="66%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Output file</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Cmodes_1024.fits</td>
<td align="left">Cosine modes applied for PIAA optics shapes optimization</td>
</tr>
<tr class="even">
<td align="left">Fmodes_1024.fits</td>
<td align="left">Fourier modes applied for PIAA optics shapes optimization</td>
</tr>
<tr class="odd">
<td align="left">piaacmcconf_i000/WFamp0_xxx.fits</td>
<td align="left">Amplitude in plane xxx</td>
</tr>
<tr class="even">
<td align="left">piaacmcconf_i000/WFpha0_xxx.fits</td>
<td align="left">Phase in plane xxx</td>
</tr>
<tr class="odd">
<td align="left">piaacmcconf_i000/conjugations.txt</td>
<td align="left">List of planes and conjugation distance to reference</td>
</tr>
<tr class="even">
<td align="left">piaacmcconf_i000/apo2Drad.fits</td>
<td align="left">Amplitude apodization (entirely allocated to PIAA optics)</td>
</tr>
<tr class="odd">
<td align="left">piaacmcconf_i000/PIAA_Mshapes.txt</td>
<td align="left">aspheric optics shapes (r0 z0 r1 z1), unit [m]</td>
</tr>
<tr class="even">
<td align="left">piaacmcconf_i000/piaam0z.fits</td>
<td align="left">first PIAA mirror sag [m]</td>
</tr>
<tr class="odd">
<td align="left">piaacmcconf_i000/piaam1z.fits</td>
<td align="left">second PIAA mirror sag [m]</td>
</tr>
<tr class="even">
<td align="left">piaacmcconf_i000/psfi0_step000.fits</td>
<td align="left">Coronagraphic PSF (flux normalized to total=1 without coronagraph)</td>
</tr>
</tbody>
</table>
<p>The conjugations.txt file should contain number, location and description of each plane:</p>
<pre><code>00  0.000000    input pupil
01  0.000000    TT mirror
02  -1.102609   pupil plane apodizer
03  1.199997    PIAA optics 0
04  -1.102609   PIAA optics 1
05  -1.102609   opaque mask at PIAA elem 1
06  -1.102609   post focal plane mask pupil
07  0.000000    Lyot mask 0
08  0.000000    back end pupil stop  (rad = 0.920000)</code></pre>
<p>The complex amplitude for each of these planes (files WFamp0_xxx.fits) should show the pupil apodization and coronagraphic effect induced by the focal plane mask which moves light into the central obstruction.</p>
<div class="figure">
<img src="figures/examplePIAA_step0_WFamp.png" alt="Amplitude in each of the 9 planes" />
<p class="caption">Amplitude in each of the 9 planes</p>
</div>
<p>The script provides some approximate performance metrics upon normal exit:</p>
<pre><code>saved -&gt; test_psfc0a.fits
    FLUX   0    114332.0000 1.000000
    FLUX   1    114332.0000 1.000000
    FLUX   2    114331.9875 1.000000
    FLUX   3    114331.9736 1.000000
    FLUX   4    114331.9445 1.000000
    FLUX   5    114331.8632 0.999999
    FLUX   6     36330.5968 0.317764
    FLUX   7       552.3991 0.004832
    FLUX   8        95.3810 0.000834
COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]
Peak constrast (rough estimate)= 3617.04 -&gt; 2.76706e-07
optsyst[0].flux[0]  = 114332
SCORINGMASKTYPE = 0
[0] Total light in scoring field = 1.32039e+06, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 4.14658e-08</code></pre>
</div>
<div id="step-001-propagate-solution-and-compute-psf" class="section level2">
<h2><span class="header-section-number">3.3</span> STEP 001: Propagate solution and compute PSF</h2>
<p>The previous solution is propagated. This should yield the same result as step 0. This should take approximately 1mn.</p>
<pre><code>    FLUX   0    114332.0000 1.000000
    FLUX   1    114332.0000 1.000000
    FLUX   2    114331.9848 1.000000
    FLUX   3    114331.9558 1.000000
    FLUX   4    114331.9316 0.999999
    FLUX   5     36329.5003 0.317754
    FLUX   6       542.4649 0.004745
    FLUX   7        96.0420 0.000840
COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]
Peak constrast (rough estimate)= 3025.69 -&gt; 2.31467e-07
optsyst[0].flux[0]  = 114332
SCORINGMASKTYPE = 0
[0] Total light in scoring field = 1.3261e+06, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 4.1645e-08</code></pre>
</div>
<div id="step-002-specify-input-pupil-geometry" class="section level2">
<h2><span class="header-section-number">3.4</span> STEP 002: Specify input pupil geometry</h2>
<p>The pupil geometry is copied to file <code>piaacmcconf_i000/pupa0_1024.fits</code></p>
</div>
<div id="step-003-mode-0-compute-on-axis-psf-for-new-pupil-geometry" class="section level2">
<h2><span class="header-section-number">3.5</span> STEP 003 (mode = 0): compute on-axis PSF for new pupil geometry</h2>
<p>Same as step 1, but taking into account the pupil geometry. With spiders or gaps in the pupil, the contrast will not be as good</p>
<pre><code>    FLUX   0    416183.9306 1.000000
    FLUX   1    416183.9306 1.000000
    FLUX   2    416183.8669 1.000000
    FLUX   3    416183.7614 1.000000
    FLUX   4    416183.7012 0.999999
    FLUX   5    155983.4386 0.374794
    FLUX   6     32825.0378 0.078871
    FLUX   7     30509.7138 0.073308
COMPUTING UNRESOLVED SOURCE PSF -*- [0.000000 x 0.000000]
Peak constrast (rough estimate)= 2.74249e+07 -&gt; 0.000158334
optsyst[0].flux[0]  = 416184
SCORINGMASKTYPE = 0
[0] Total light in scoring field = 7.35517e+09, peak PSF = -1, SCOTINGTOTAL = 2436   -&gt; Average contrast = 1.74319e-05</code></pre>
<p>This step should take approximately 1mn.</p>
</div>
<div id="step-004-mode-5-compute-lyot-stops-shapes-and-locations-1st-pass" class="section level2">
<h2><span class="header-section-number">3.6</span> STEP 004 (mode = 5): Compute Lyot stops shapes and locations, 1st pass</h2>
<p>For circular centrally obscured pupils, the default Lyot stops configuration consists of two stops: one that masks the outer part of the beam, and one that masks the central obstruction.</p>
<p>Fine optimization of the stops locations is done with a separate command. The optional lsoptrange value is the range (unit: m) for the mask position search.</p>
</div>
<div id="step-005-mode-2-optimize-focal-plane-mask-transmission-1st-pass" class="section level2">
<h2><span class="header-section-number">3.7</span> STEP 005 (mode = 2): Optimize focal plane mask transmission, 1st pass</h2>
</div>
<div id="step-006-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput" class="section level2">
<h2><span class="header-section-number">3.8</span> STEP 006 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</h2>
</div>
<div id="step-007-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-10-cosine-modes-5-fourier-modes" class="section level2">
<h2><span class="header-section-number">3.9</span> STEP 007 (mode = 40): Tune PIAA shapes and focal plane mask transm, 10 cosine modes, 5 Fourier modes</h2>
<p>This takes approximately 20mn for size = 1024.Progress can be tracked by watching file : tail -f linoptval.txt </p>
</div>
<div id="step-008-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes" class="section level2">
<h2><span class="header-section-number">3.10</span> STEP 008 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</h2>
</div>
<div id="step-009-mode-5-compute-lyot-stops-shapes-and-locations-2nd-pass-70-throughput" class="section level2">
<h2><span class="header-section-number">3.11</span> STEP 009 (mode = 5): Compute Lyot stops shapes and locations, 2nd pass, 70% throughput</h2>
</div>
<div id="step-010-mode-1-tune-lyot-stops-conjugations" class="section level2">
<h2><span class="header-section-number">3.12</span> STEP 010 (mode = 1): Tune Lyot stops conjugations</h2>
</div>
<div id="step-011-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-20-cosine-modes-20-fourier-modes" class="section level2">
<h2><span class="header-section-number">3.13</span> STEP 011 (mode = 40): Tune PIAA shapes and focal plane mask transm, 20 cosine modes, 20 Fourier modes</h2>
</div>
<div id="step-012-mode-40-tune-piaa-shapes-and-focal-plane-mask-transm-40-cosine-modes-150-fourier-modes" class="section level2">
<h2><span class="header-section-number">3.14</span> STEP 012 (mode = 40): Tune PIAA shapes and focal plane mask transm, 40 cosine modes, 150 Fourier modes</h2>
<p>The total number of free parameters is 380 = (40+150)*2, so this routine takes a long time to complete (hours).</p>
</div>
<div id="step-013-mode-5-compute-lyot-stops-shapes-and-locations-3nd-pass-70-throughput" class="section level2">
<h2><span class="header-section-number">3.15</span> STEP 013 (mode = 5): Compute Lyot stops shapes and locations, 3nd pass, 70% throughput</h2>
</div>
</div>
<div id="c-code-description" class="section level1">
<h1><span class="header-section-number">4</span> C code description</h1>
<div id="piaacmc_designcodes" class="section level2">
<h2><span class="header-section-number">4.1</span> PIAACMC_designcodes</h2>
<p>The main function in the source code is PIAACMCsimul_exec(), which takes two arguments: the configuration index (usually a 3 digit integer) and the mode (integer) which describes the operation to be performed to the PIAACMC design.</p>
<table>
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Mode</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0</td>
<td align="left">Compute on-axis propagation for specified configuration. If configuration does not exist, create idealized monochromatic PIAACMC (intended to create a new index) and compute on-axis propagation</td>
</tr>
<tr class="even">
<td align="left">1</td>
<td align="left">Optimize Lyot stop(s) locations (scan)</td>
</tr>
<tr class="odd">
<td align="left">2</td>
<td align="left">Optimize focal plane mask transmission for idealized monochromatic PIAACMC (scan)</td>
</tr>
<tr class="even">
<td align="left">3</td>
<td align="left">Run without focal plane mask (for testing and calibration)</td>
</tr>
<tr class="odd">
<td align="left">4</td>
<td align="left">Linear optimization around current design, free parameters = PIAA optics cosines shapes (track progress by looking at val.opt file)</td>
</tr>
<tr class="even">
<td align="left">5</td>
<td align="left">Optimize Lyot stops shapes and positions</td>
</tr>
<tr class="odd">
<td align="left">10</td>
<td align="left">Setup polychromatic optimization</td>
</tr>
<tr class="even">
<td align="left">11</td>
<td align="left">Compute polychromatic response to zones, store result in FPMresp</td>
</tr>
<tr class="odd">
<td align="left">12</td>
<td align="left">Search for best mask solution using FPMresp, random search</td>
</tr>
<tr class="even">
<td align="left">13</td>
<td align="left">Optimize PIAA optics shapes and focal plane mask transmission (idealized PIAACMC)</td>
</tr>
<tr class="odd">
<td align="left">40</td>
<td align="left">Optimize PIAA optics shapes and focal plane mask transmission (idealized PIAACMC)</td>
</tr>
<tr class="even">
<td align="left">41</td>
<td align="left">Optimize PIAA optics shapes and focal plane mask zones (polychromatic)</td>
</tr>
<tr class="odd">
<td align="left">100</td>
<td align="left">Evaluate current design: polychromatic contrast, pointing sensitivity</td>
</tr>
<tr class="even">
<td align="left">101</td>
<td align="left">Transmission as a function of angular separation</td>
</tr>
<tr class="odd">
<td align="left">200</td>
<td align="left">Make focal plane mask OPD map</td>
</tr>
</tbody>
</table>
<p>The following variables can be set :</p>
<table style="width:81%;">
<colgroup>
<col width="29%" />
<col width="51%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Variable</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">PIAACMC_size</td>
<td align="left">Array size (1024, 2048, etc...)</td>
</tr>
<tr class="even">
<td align="left">PIAACMC_pixscale</td>
<td align="left">Pixel scale [m]</td>
</tr>
<tr class="odd">
<td align="left">PIAACMC_dftgrid</td>
<td align="left">Sampling interval in DFTs</td>
</tr>
<tr class="even">
<td align="left">PIAACMC_centobs0</td>
<td align="left">Input central obstruction</td>
</tr>
<tr class="odd">
<td align="left">PIAACMC_centobs1</td>
<td align="left">Output central obstruction</td>
</tr>
<tr class="even">
<td align="left">PIAACMC_nblambda</td>
<td align="left">Number of wavelength points</td>
</tr>
<tr class="odd">
<td align="left">PIAACMC_resolved</td>
<td align="left">1 if resolved source (3 points at r = 0.01 l/D, 120 deg apart)</td>
</tr>
<tr class="even">
<td align="left">PIAACMC_fpmtype</td>
<td align="left">1 if physical mask, 0 if idealized mask</td>
</tr>
<tr class="odd">
<td align="left">PIAACMC_FPMsectors</td>
<td align="left">Number of sectors in focal plane mask</td>
</tr>
<tr class="even">
<td align="left">PIAACMC_NBrings</td>
<td align="left">Number of rings in focal plane mask</td>
</tr>
<tr class="odd">
<td align="left">PIAACMC_fpmradld</td>
<td align="left">Focal plane mask outer radius</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="initialization-rules-function-piaasimul_initpiaacmc" class="section level1">
<h1><span class="header-section-number">5</span> Initialization rules (function PIAAsimul_initpiaacmc() )</h1>
<ul>
<li><p>if configuration directory exists, use it and load configuration file ( function PIAAsimul_loadpiaacmcconf ), otherwise, create it</p></li>
<li><p>load/create Cmodes</p></li>
<li><p>load/create Fmodes</p></li>
<li><p>load mode coefficients for piaa shapes if they exist. If not:</p>
<ul>
<li><p>create radial apodization for centrally obscured idealized monochromatic PIAACMC</p></li>
<li><p>fit / extrapolate radial apodization profile with cosines</p></li>
<li><p>using above fit, create 2D radial sag for both PIAA optics ( -&gt; PIAA_Mshapes.txt)</p></li>
<li><p>make 2D sag maps for both optics ( -&gt; piaa0z.fits, piaa1z.fits)</p></li>
<li><p>fit 2D sag maps with Cmodes and Fmodes coefficients ( -&gt; piaa0Cmodes, piaa0Fmodes, piaa1Cmodes, piaa1Fmodes )</p></li>
</ul></li>
<li><p>load/create focal plane mask zone map. This is the map that defines the geometry (which ring is where)</p></li>
<li><p>load/create focal plane mask thickness array</p></li>
<li><p>load/create focal plane mask transmission array</p></li>
<li><p>load/create Lyot stops</p></li>
</ul>
<div id="code-breakdown" class="section level3">
<h3><span class="header-section-number">5.0.1</span> Code breakdown</h3>
<ul>
<li>PIAACMCsimul_exec() :
<ul>
<li>PIAAsimul_initpiaacmcconf(): Load/Creates/initializes piaacmcconf structure and directory
<ul>
<li>perform default initialization</li>
<li>PIAAsimul_loadpiaacmcconf(): Loading PIAACMC configuration from &quot;piaacmcconfxxx/piaacmcparams.conf&quot; if it exists</li>
<li>Creating/loading Cmodes and Fmodes</li>
<li>IMPORT / CREATE PIAA SHAPES
<ul>
<li>create 2D prolate iteratively</li>
<li>PIAACMCsimul_load2DRadialApodization():fit PIAA shapes with Cosine modes</li>
<li>PIAACMCsimul_init_geomPIAA_rad(): compute radial PIAA sag from cosine apodization fit</li>
<li>PIAACMCsimul_mkPIAAMshapes_from_RadSag(): Make 2D sag shapes from radial PIAA sag</li>
</ul></li>
<li>MAKE FOCAL PLANE MASK</li>
<li>MAKE LYOT STOPS</li>
<li>PIAAsimul_savepiaacmcconf(): save configuration</li>
</ul></li>
<li>PIAACMCsimul_makePIAAshapes(): construct PIAA shapes from fitting coefficients
<ul>
<li>construct 2D PIAA mirror shapes from piaa0Cmodescoeff, piaa0Fmodescoeff, piaa1Cmodescoeff, piaa1Fmodescoeff</li>
</ul></li>
<li>PIAACMCsimul_computePSF(): Compute PSF</li>
</ul></li>
</ul>
</div>
<div id="output-files" class="section level3">
<h3><span class="header-section-number">5.0.2</span> Output Files</h3>
<p>APLCmaskCtransm.txt ?? fpm_ampl.fits fpm_pha.fits FPmask.tmp.fits</p>
<div id="configuration" class="section level4">
<h4><span class="header-section-number">5.0.2.1</span> Configuration :</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/piaacmcparams.conf</td>
<td>Configuration parameters</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/conjugations.txt</td>
<td>Conjugations</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/lambdalist.txt</td>
<td>list of wavelength values</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/pupa0_[size].fits</td>
<td>input pupil (created by default if does not exist)</td>
</tr>
</tbody>
</table>
</div>
<div id="wavefront-modes" class="section level4">
<h4><span class="header-section-number">5.0.2.2</span> Wavefront Modes :</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cmodes.fits</td>
<td>circular radial cosine modes (40 modes, hard coded)</td>
</tr>
<tr class="even">
<td>Fmodes.fits</td>
<td>Fourier modes (625 modes = 10 CPA, hard coded)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/ModesExpr_CPA.txt</td>
<td>modes definition</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/APOmodesCos.fits</td>
<td>Cosine modes for fitting 2D apodization profile</td>
</tr>
</tbody>
</table>
</div>
<div id="piaa-mirrors-apodization-fits" class="section level4">
<h4><span class="header-section-number">5.0.2.3</span> PIAA mirrors, apodization, fits:</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/APLCapo.1.400.0.300.info</td>
<td>file written by prolate generation function coronagraph_make_2Dprolate in coronagraphs.c</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/apo2Drad.fits</td>
<td>idealized PIAACMC 2D apodization</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaam0z.fits</td>
<td>PIAA M0 shape (2D sag)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaam1z.fits</td>
<td>PIAA M1 shape (2D sag)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/PIAA_Mshapes.txt</td>
<td>PIAA shapes (radial txt file, cols: r0, z0, r1, z1)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Fz.fits</td>
<td>PIAA M0 shape, Fourier components (2D file)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Fz.fits</td>
<td>PIAA M1 shape, Fourier components (2D file)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Cmodes.fits</td>
<td>idealized PIAACMC mirror 0 cosine modes (copied from ./piaaref/)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa0Fmodes.fits</td>
<td>idealized PIAACMC mirror 0 Fourier modes (copied from ./piaaref/)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa1Cmodes.fits</td>
<td>idealized PIAACMC mirror 1 cosine modes (copied from ./piaaref/)</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Fmodes.fits</td>
<td>idealized PIAACMC mirror 1 Fourier modes (copied from ./piaaref/)</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Cres.fits</td>
<td>idealized PIAA M0 cosine fit residual</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Cres.fits</td>
<td>idealized PIAA M1 cosine fit residual</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Cz.fits</td>
<td>idealized PIAA M0 cosine fit sag</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Cz.fits</td>
<td>idealized PIAA M1 cosine fit sag</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaa0Fz.fits</td>
<td>idealized PIAA M0 Fourier fit sag</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaa1Fz.fits</td>
<td>idealized PIAA M1 Fourier fit sag</td>
</tr>
</tbody>
</table>
</div>
<div id="idealized-piaacmc-reference-point" class="section level4">
<h4><span class="header-section-number">5.0.2.4</span> Idealized PIAACMC reference point:</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/piaaref/APLCmaskCtransm.txt</td>
<td>idealized PIAACMC focal plane mask transmission</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaaref/apo2Drad.fits</td>
<td>idealized PIAACMC output apodization</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaaref/piaa0Cmodes.fits</td>
<td>idealized PIAACMC mirror 0 cosine modes</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaaref/piaa0Fmodes.fits</td>
<td>idealized PIAACMC mirror 0 Fourier modes</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/piaaref/piaa1Cmodes.fits</td>
<td>idealized PIAACMC mirror 1 cosine modes</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/piaaref/piaa1Fmodes.fits</td>
<td>idealized PIAACMC mirror 1 Fourier modes</td>
</tr>
</tbody>
</table>
</div>
<div id="focal-plane-mask" class="section level4">
<h4><span class="header-section-number">5.0.2.5</span> Focal plane mask:</h4>
<p>Focal plane mask design defined by : - [s] Sectors flag (0: no sectors, 1: sectors), variable PIAACMC_FPMsectors - [r] Resolved target flag (0: point source, 1: resolved source) - [mr] Mask radius in units of 0.1 l/D - [rrr] number of rings, variable piaacmc[0].NBrings - [zzz] number of zones</p>
<table>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>fpmzmap[s]<em>[rrr]</em>[zzz].fits</td>
<td>Zones map</td>
</tr>
<tr class="even">
<td>fpm_zonea[r][s]<em>[mr]</em>[rrr]_[zzz].fits</td>
<td>amplitude for each zone</td>
</tr>
<tr class="odd">
<td>fpm_zonea[r][s]<em>[mr]</em>[rrr]_[zzz].fits</td>
<td>thickness for each zone</td>
</tr>
</tbody>
</table>
<p>IDEALIZED OR PHYSICAL MASK</p>
<p>Idealized mask is a single zone mask with thickness adjusted for lambda/2 phase shift and a (non-physical) partial transmission. Physical mask consist of 1 or more zones with full transmission. Each zone can have a different thickness.</p>
<p>By default, a non-physical mask is first created with transmission piaacmc[0].fpmaskamptransm read from piaacmcparams.conf. Computations indices using a physical mask: - set transmission to 1.0: piaacmc[0].fpmaskamptransm = 1.0. - set focal plane mask radius to larger value: piaacmc[0].fpmRad = 0.5<em>(LAMBDASTART+LAMBDAEND)</em>piaacmc[0].Fratio * PIAACMC_MASKRADLD</p>
</div>
<div id="lyot-stops" class="section level4">
<h4><span class="header-section-number">5.0.2.6</span> Lyot stops:</h4>
<table>
<thead>
<tr class="header">
<th>Output file</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/LyotStop0.fits</td>
<td>Lyot Stop 0</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/LyotStop1.fits</td>
<td>Lyot Stop 1</td>
</tr>
</tbody>
</table>
</div>
<div id="amplitude-phase-at-planes" class="section level4">
<h4><span class="header-section-number">5.0.2.7</span> Amplitude &amp; Phase at planes:</h4>
<p>Files are /piaaconfxxx/WFamp_nnn.fits and WFpha_nnn.fits, where nnn is the plane index.Complex amplitude is shown AFTER the element has been applied, in the plane of the element.</p>
<table>
<thead>
<tr class="header">
<th>Plane index</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>000</td>
<td>Input pupil</td>
</tr>
<tr class="even">
<td>001</td>
<td>Fold mirror used to induce pointing offsets</td>
</tr>
<tr class="odd">
<td>002</td>
<td>PIAA M0</td>
</tr>
<tr class="even">
<td>003</td>
<td>PIAA M1</td>
</tr>
<tr class="odd">
<td>004</td>
<td>PIAAM1 edge opaque mask</td>
</tr>
<tr class="even">
<td>005</td>
<td>post-focal plane mask pupil</td>
</tr>
<tr class="odd">
<td>006</td>
<td>Lyot Stop 0</td>
</tr>
<tr class="even">
<td>007</td>
<td>Lyot Stop 1</td>
</tr>
<tr class="odd">
<td>008</td>
<td>invPIAA1</td>
</tr>
<tr class="even">
<td>009</td>
<td>invPIAA0</td>
</tr>
<tr class="odd">
<td>010</td>
<td>back end mask</td>
</tr>
</tbody>
</table>
</div>
<div id="performance-evaluation" class="section level4">
<h4><span class="header-section-number">5.0.2.8</span> Performance Evaluation:</h4>
<table style="width:76%;">
<colgroup>
<col width="23%" />
<col width="52%" />
</colgroup>
<thead>
<tr class="header">
<th>Plane index</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>./piaaconfxxx/scoringmask0.fits</td>
<td>Evaluation points in focal plane, hardcoded in PIAACMCsimul_computePSF()</td>
</tr>
<tr class="even">
<td>./piaaconfxxx/CnormFactor.txt</td>
<td>PSF normalization factor used to compute contrast</td>
</tr>
<tr class="odd">
<td>./piaaconfxxx/flux.txt</td>
<td>total intensity at each plane</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="low-level-c-code" class="section level1">
<h1><span class="header-section-number">6</span> Low-level C code</h1>
<div id="key-functions" class="section level2">
<h2><span class="header-section-number">6.1</span> Key functions</h2>
<p>Every time a PSF is computed, the following 3 functions are created in that order:</p>
<ul>
<li><code>PIAAsimul_initpiaacmcconf</code>
<ul>
<li>initialize piaacmc</li>
<li>create modes for aspheric optical surfaces description</li>
<li>CREATE DMs (Cmodes and Fmodes)</li>
<li>IMPORT / CREATE PIAA SHAPES</li>
<li>if does not exist: Creating 2D apodization for idealized circular monochromatic PIAACMC</li>
<li>compute radial PIAA sag, make 2D sag maps</li>
<li>MAKE FOCAL PLANE MASK</li>
<li>MAKE LYOT STOPS (LOADING/CREATING LYOT MASK)</li>
</ul></li>
<li><p><code>PIAACMCsimul_init(piaacmc, 0, xld, yld)</code> : initializes optical system to piaacmc design</p></li>
<li><p><code>PIAACMCsimul_makePIAAshapes(piaacmc, 0)</code> : create 2D PIAA shapes (<code>piaam0z</code> and <code>piaam1z</code>) from coefficient values and modes</p></li>
<li><p><code>OptSystProp_run(optsyst, 0, startelem, optsyst[0].NBelem, piaacmcconfdir, 0)</code> : perform optical propagation</p></li>
</ul>
<p>Note that the last 3 functions are wrapped togeter in the computePSF function, which allows multi-point (extended sources) :</p>
<ul>
<li><code>PIAACMCsimul_computePSF(float xld, float yld, long startelem, long endelem, int savepsf, int sourcesize, int extmode, int outsave)</code> : compute PSF
<ul>
<li><code>PIAACMCsimul_init(piaacmc, 0, xld+rad1, yld)</code></li>
<li><code>PIAACMCsimul_makePIAAshapes(piaacmc, 0)</code></li>
<li><code>OptSystProp_run(optsyst, 0, startelem, optsyst[0].NBelem, piaacmcconfdir, 0)</code></li>
</ul></li>
</ul>
</div>
<div id="full-piaacmc-design-in-monochromatic-light" class="section level2">
<h2><span class="header-section-number">6.2</span> Full PIAACMC design in monochromatic light</h2>
<p>The first step of the optimization process is to compute the PIAACMC optics and focal plane mask in the idealized case: monochromatic light, point source, and ideal focal plane mask (circular, phase-shifting and partially transmissive). Steps are shown in the figure below and correspond to steps in the <code>runPIAACMC</code> state machine.</p>
<div class="figure">
<img src="figures/runPIAACMCsteps.jpg" alt="PIAACMC design steps" />
<p class="caption">PIAACMC design steps</p>
</div>
</div>
<div id="aplc-design" class="section level2">
<h2><span class="header-section-number">6.3</span> APLC design</h2>
<p>The scripts produce an APLC design by setting <code>PIAAmode = 0</code>. In that case, only <code>step000</code> in the figure above is executed.</p>
</div>
<div id="focal-plane-mask-optimization" class="section level2">
<h2><span class="header-section-number">6.4</span> Focal plane mask optimization</h2>
<div id="overall-flow" class="section level3">
<h3><span class="header-section-number">6.4.1</span> Overall flow</h3>
<p>FPM optimization is done as <code>mode = 13</code> in the main routine. It is called from the <code>runPIAACMC</code> script.<br />
The <code>PIAACMCsimul_run(char *confindex, long mode)</code> function loop-calls the <code>PIAACMCsimul_exec(char *confindex, long mode)</code> function with mode 13 until search time is reached.</p>
<p>Each search proceeds as follows :</p>
<ul>
<li>a starting point is picked. A random integer <code>zeroST</code> encodes the starting poing:
<ul>
<li>0:</li>
<li>1: start at zero</li>
<li>2: start at best solution</li>
</ul></li>
<li>run <code>PIAACMCsimul_exec</code> in mode 13
<ul>
<li>randomly move next to starting point</li>
<li>compute value and store it to valref variable</li>
<li>enter gradient search loop
<ul>
<li>compute local derivatives</li>
<li>compute SVD of Jacobian matrix to identify vectors of steepest descent</li>
<li>for each alphareg = 0, 0.25, 0.5, 0.75, 1.0:
<ul>
<li>do a linescan descent along the vector identified by SVD, with the alphareg regularization coefficient</li>
<li>the best value is stored as <code>bestval</code> and the corresponding parameters into <code>data.image[IDoptvec].array.F[i]</code></li>
<li>store best values in <code>PIAACMCSIMUL_VAL</code>, and reference value in <code>PIAACMCSIMUL_VALREF</code></li>
</ul></li>
</ul></li>
</ul></li>
<li><code>computePSF_FAST_FPMresp = 1</code> : uses pre-computed complex amplitude zones response to evaluate FPM solutions</li>
<li><code>PIAACMC_FPM_FASTDERIVATIVES = 1</code></li>
</ul>
<p>To stop the optimization and have the current best solution adopted, enter a small value in the <code>searchtime.txt</code> file, so that the optimization process completes.</p>
</div>
<div id="regularization" class="section level3">
<h3><span class="header-section-number">6.4.2</span> Regularization</h3>
<p>There are two regularization:</p>
<ul>
<li>Focal plane mask zone sags can be included in the linear optimization as extra components to the optimization vector</li>
<li>PIAA shapes coefficients are simply added to the evaluation metric</li>
</ul>
</div>
<div id="key-files" class="section level3">
<h3><span class="header-section-number">6.4.3</span> Key files</h3>
<ul>
<li><code>fpm_zonez_.....best.fits</code> is the optimal solution</li>
<li><code>mode13_....bestval.txt</code> is the corresponding value</li>
</ul>
<p>To restart the optimization from scratch, remove these two files.</p>
<p>Average contrast = 5.964e-05 0.001 -&gt; Average contrast = 8.57575e-07, 1.9e-7 0.01 -&gt; Average contrast = 7.99085e-07, 2.0e-7 7.8294e-07</p>
</div>
</div>
</div>
</body>
</html>
