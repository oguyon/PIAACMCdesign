#!/bin/bash

# Designing PIAACMC 




mkdir -p conf



function loadparam() {
file="conf/conf_$1.txt"
if [ ! -f $file ]; then
echo "$2" > $file
fi
var=$( cat "$file" )
eval "$1=$var"
}

function printvar() {
eval "var=${!1}"
printf "%20s  [%10s]  %s\n" "$1" "$var" "$2"
}


# loading parameters
# 2nd arg is default value

loadparam coin 0.300
loadparam coout 0.290
loadparam fpmradld 1.100
loadparam PIAAmaterial "Mirror"
loadparam LStransm 0.70
loadparam NBls 4
loadparam lambda 565
loadparam mlambda 565
loadparam mlambdaB 10
loadparam NBrings 22
loadparam maskradld 1.60
loadparam ssize 20
loadparam extmode 0

loadparam fpmmaterial "Mirror"
loadparam fpmminsag "-1e-6"
loadparam fpmmaxsag "1e-6"

loadparam fpmccnbr 0
loadparam fpmccz $fpmmaxsag
loadparam fpmocradld 8.0
loadparam fpmocz 0.0

loadparam PIAAbeamrad 0.022
loadparam pscale 0.00011
loadparam Fratio 80.0
loadparam PIAAr0lim 1.15 
loadparam PIAAr1lim 1.50
loadparam PIAAsep 2.302606
loadparam PIAA0pos 0.702843 



function printvarall() {

printvar "coin" "central obstruction at input beam [beam radius]"
printvar "coout" "central obstrcution at output beam [beam radius]"
printvar "fpmradld" "focal plane mask radius [l/D]"
printvar "PIAAmaterial" "PIAA optics material"
printvar "LStransm" "Lyot stop transmission"
printvar "NBls" "Number of Lyot stops"
printvar "lambda" "Wavelength for monochromatic design [nm]"
printvar "mlambda" "central wavelength for polychromatic design [nm]"
printvar "mlambdaB" "spectral bandwidth [%]"
printvar "NBrings" "number of rings in focal plane mask"
printvar "maskradld" "mask outer radius at central wavelength [l/D]"
printvar "ssize" "source angular size for mask optimization (20: 0.01 l/D; 10: 0.1 l/D)"
printvar "extmode" "source extent mode (0: 3 points; 1: 6 points)"
echo "FOCAL PLANE MASK DESIGN:"
printvar "fpmmaterial" "focal plane mask material"
printvar "fpmminsag" "min focal plane mask sag"
printvar "fpmmaxsag" "max focal plane mask sag"
printvar "fpmccnbr" "how many central rings replaced by cone (set to 0 if no central cone)"
printvar "fpmccz" "sag at cone center (sag at cone edge will be midpoint between minsag and maxsag)"
printvar "fpmocradld" "outer cone outer radius [l/D]"
printvar "fpmocz" "ag at inner edge of outer cone (sag = 0 at outer edge), set to 0 if no outer cone"
echo "OPTICAL DESIGN:"
printvar "PIAAbeamrad" "beam radius [mm]"
printvar "pscale" "pixel scale in pupil [m/pix]"
printvar "Fratio" "F ratio at focal plane mask"
printvar "PIAAr0lim" "outer edge of PIAA optic 0 [beam radius unit]"
printvar "PIAAr1lim" "outer edge of PIAA optic 1 [beam radius unit]"
printvar "PIAAsep" "distance between PIAA optics [m]"
printvar "PIAA0pos" "PIAA optic 0 distance from pupil plane [m]"

}



printhelp ()
{
echo "------------------------------------------------------------------------"
echo "                 PIAACMC DESIGN: TOP LEVEL SCRIPT"
echo " Edit script to set PIAACMC design parameters"
echo " Design parameters stored in conf/conf_<param>.txt"
echo " Design parameters list [current value]:"

printvarall

echo " $0 <command>"
echo "  command : "
echo "     optsingle : optimize"
echo "     eval0 : level 0 evaluation"
echo "     eval1 : level 1 evaluation"
echo "     eval2 : level 2 evaluation"
echo "------------------------------------------------------------------------"
}

NBARGS=1

if [ "$1" = "help" ] || [ "$#" -ne $NBARGS ]; then
        printhelp
if [ "$#" -ne $NBARGS ]; then
    echo "Illegal number of parameters ($NBARGS params required, $# entered)"
fi
        exit
fi


runoptcmd=$1



echo "18" > conf_MdesignStepMax.txt




# 5  4.62845e-06
# 6  2.73012e-07
# 7  1.2657e-07
# 8  5.73497e-08    #2.89903e-06
# 9  4.82752e-08    #5.04682e-07
#10  5.74245e-08    #5.15738e-07
#11  5.76306e-08    #5.19874e-07
#12  5.47897e-08    #6.15752e-05
#13  7.87868e-09    #6.57179e-05
#14  1.08568e-07    #6.88505e-05
#15  8.74249e-08
#16  4.1511e-08 
#17  1.56353e-08
#18  

./runopt $runoptcmd $pscale $coin $coout $fpmradld $lambda $PIAAmaterial $LStransm $NBls $mlambda $mlambdaB $NBrings $maskradld $ssize $extmode $fpmmaterial $fpmminsag $fpmmaxsag $fpmccnbr $fpmccz $fpmocradld $fpmocz 000


